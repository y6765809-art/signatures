<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×–×¨×™××” ×¤×œ×•×¡ - ××¢×¨×›×ª ×—×ª×™××•×ª ×“×™×’×™×˜×œ×™×•×ª</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --color-primary: #00BCD4;
            --color-secondary: #FFD700;
            --color-accent: #FF6B6B;
            --color-success: #4CAF50;
            --color-warning: #FF9800;
            --color-danger: #F44336;
            --color-dark: #212121;
            --color-light: #FAFAFA;
        }
        
        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
        }
        
        .slogan {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }
        
        .license-section {
            text-align: left;
            direction: ltr;
        }
        
        .license-badge {
            background: var(--color-success);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        .left-panel, .right-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .panel-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--color-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Upload Zone */
        .upload-zone {
            border: 3px dashed var(--color-primary);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f9ff;
        }
        
        .upload-zone:hover {
            border-color: var(--color-secondary);
            background: #e0f2fe;
            transform: translateY(-2px);
        }
        
        .upload-zone.dragover {
            border-color: var(--color-success);
            background: #dcfce7;
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--color-dark);
        }
        
        .upload-subtext {
            font-size: 14px;
            color: #666;
        }
        
        /* PDF Viewer */
        .pdf-viewer {
            display: none;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            background: #f9fafb;
        }
        
        .pdf-toolbar {
            background: var(--color-dark);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .pdf-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .pdf-controls {
            display: flex;
            gap: 10px;
        }
        
        .pdf-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .pdf-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .pdf-canvas-container {
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            background: white;
        }
        
        #pdfCanvas {
            display: block;
            margin: 0 auto;
            cursor: crosshair;
        }
        
        /* Field Marker on PDF */
        .field-marker {
            position: absolute;
            border: 2px solid;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            padding: 5px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        /* Right Panel - Fields */
        .field-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .field-type-btn {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .field-type-btn:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .field-type-btn.active {
            border-color: var(--color-primary);
            background: #f0f9ff;
        }
        
        .field-icon {
            font-size: 24px;
        }
        
        .field-name {
            font-size: 12px;
            font-weight: 600;
        }
        
        .custom-field-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: 'Heebo', sans-serif;
        }
        
        .add-field-btn {
            width: 100%;
            padding: 12px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-field-btn:hover {
            background: #0097a7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,188,212,0.3);
        }
        
        .add-field-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Fields List */
        .fields-list {
            margin-top: 20px;
        }
        
        .field-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .field-item:hover {
            border-color: var(--color-primary);
        }
        
        .field-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .remove-field-btn {
            background: var(--color-danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .remove-field-btn:hover {
            background: #d32f2f;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-danger {
            background: var(--color-danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .btn-warning {
            background: var(--color-warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #f57c00;
        }
        
        /* Create Link Section */
        .create-link-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--color-dark);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn-create-link {
            width: 100%;
            padding: 15px;
            background: var(--color-success);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-create-link:hover {
            background: #388e3c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76,175,80,0.3);
        }
        
        .btn-create-link:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Link Result */
        .link-result {
            display: none;
            background: #dcfce7;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .link-url {
            background: white;
            padding: 10px;
            border-radius: 6px;
            word-break: break-all;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .send-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-send {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-copy {
            background: var(--color-primary);
            color: white;
        }
        
        .btn-email {
            background: #EA4335;
            color: white;
        }
        
        .btn-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .btn-qr {
            background: var(--color-dark);
            color: white;
        }
        
        /* History Section */
        .history-section {
            margin-top: 30px;
        }
        
        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .filter-select {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            border-color: var(--color-primary);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-title {
            font-weight: 600;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .status-created { background: #94A3B8; }
        .status-sent { background: #3B82F6; }
        .status-viewed { background: #F59E0B; }
        .status-signed { background: #10B981; }
        .status-expired { background: #EF4444; }
        
        .history-details {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .history-actions {
            display: flex;
            gap: 5px;
        }
        
        .history-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .alert-success {
            background: var(--color-success);
            color: white;
        }
        
        .alert-error {
            background: var(--color-danger);
            color: white;
        }
        
        .alert-warning {
            background: var(--color-warning);
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .field-selector {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .send-options {
                flex-direction: column;
            }
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">ğŸ’° ×–×¨×™××” ×¤×œ×•×¡</div>
                <div>
                    <div class="slogan">×ª×Ÿ ×œ×›×¡×£ ×©×œ×š ×œ×–×¨×•×</div>
                </div>
            </div>
            <div class="license-section">
                <div class="license-badge">âœ… ×¨×™×©×™×•×Ÿ: SIG-2024-TEST-DEMO</div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - PDF Viewer -->
            <div class="left-panel">
                <h2 class="panel-title">ğŸ“„ ××¡××š PDF</h2>
                
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">ğŸ“¤</div>
                    <div class="upload-text">×’×¨×•×¨ PDF ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</div>
                    <div class="upload-subtext">×§×•×‘×¥ PDF ×¢×“ 50MB</div>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                </div>
                
                <!-- PDF Viewer -->
                <div class="pdf-viewer" id="pdfViewer">
                    <div class="pdf-toolbar">
                        <div class="pdf-info">
                            <span id="pdfName">××¡××š.pdf</span>
                            <span id="pdfPages">×¢××•×“ 1 ××ª×•×š 1</span>
                        </div>
                        <div class="pdf-controls">
                            <button class="pdf-btn" id="zoomOut">ğŸ”-</button>
                            <button class="pdf-btn" id="zoomIn">ğŸ”+</button>
                            <button class="pdf-btn" id="prevPage">â—€</button>
                            <button class="pdf-btn" id="nextPage">â–¶</button>
                        </div>
                    </div>
                    <div class="pdf-canvas-container" id="pdfCanvasContainer">
                        <canvas id="pdfCanvas"></canvas>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons hidden" id="actionButtons">
                    <button class="btn btn-danger" id="removeFile">ğŸ—‘ï¸ ×”×¡×¨ ×§×•×‘×¥</button>
                    <button class="btn btn-warning" id="removeAll">âŒ ×”×¡×¨ ×”×›×œ</button>
                </div>
                
                <!-- History Section -->
                <div class="history-section">
                    <h2 class="panel-title">ğŸ“š ×”×™×¡×˜×•×¨×™×”</h2>
                    <div class="history-controls">
                        <input type="text" class="search-input" id="searchHistory" placeholder="ğŸ” ×—×™×¤×•×©...">
                        <select class="filter-select" id="filterStatus">
                            <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                            <option value="created">× ×•×¦×¨</option>
                            <option value="sent">× ×©×œ×—</option>
                            <option value="viewed">× ×¦×¤×”</option>
                            <option value="signed">× ×—×ª×</option>
                            <option value="expired">×¤×’ ×ª×•×§×£</option>
                        </select>
                    </div>
                    <div class="history-list" id="historyList">
                        <p style="text-align: center; color: #666; padding: 20px;">××™×Ÿ ××¡××›×™× ×¢×“×™×™×Ÿ</p>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Fields & Settings -->
            <div class="right-panel">
                <h2 class="panel-title">ğŸ“ ×”×•×¡×¤×ª ×©×“×•×ª</h2>
                
                <!-- Field Type Selector -->
                <div class="field-selector" id="fieldSelector">
                    <button class="field-type-btn" data-type="signature">
                        <span class="field-icon">âœï¸</span>
                        <span class="field-name">×—×ª×™××”</span>
                    </button>
                    <button class="field-type-btn" data-type="name">
                        <span class="field-icon">ğŸ‘¤</span>
                        <span class="field-name">×©× ××œ×</span>
                    </button>
                    <button class="field-type-btn" data-type="email">
                        <span class="field-icon">ğŸ“§</span>
                        <span class="field-name">××™×™×œ</span>
                    </button>
                    <button class="field-type-btn" data-type="phone">
                        <span class="field-icon">ğŸ“±</span>
                        <span class="field-name">×˜×œ×¤×•×Ÿ</span>
                    </button>
                    <button class="field-type-btn" data-type="idNumber">
                        <span class="field-icon">ğŸ†”</span>
                        <span class="field-name">×ª"×–</span>
                    </button>
                    <button class="field-type-btn" data-type="date">
                        <span class="field-icon">ğŸ“…</span>
                        <span class="field-name">×ª××¨×™×š</span>
                    </button>
                    <button class="field-type-btn" data-type="custom">
                        <span class="field-icon">ğŸ“</span>
                        <span class="field-name">××•×ª××</span>
                    </button>
                </div>
                
                <!-- Custom Field Input -->
                <input type="text" class="custom-field-input hidden" id="customFieldName" placeholder="×©× ×”×©×“×” ×”××•×ª××...">
                
                <!-- Add Field Button -->
                <button class="add-field-btn" id="addFieldBtn" disabled>
                    â• ×”×•×¡×£ ×©×“×” - ×œ×—×¥ ×¢×œ ×”-PDF
                </button>
                
                <!-- Fields List -->
                <div class="fields-list" id="fieldsList"></div>
                
                <!-- Create Link Section -->
                <div class="create-link-section">
                    <h2 class="panel-title">ğŸ”— ×™×¦×™×¨×ª ×§×™×©×•×¨</h2>
                    
                    <div class="form-group">
                        <label class="form-label">×©× ×”××¡××š</label>
                        <input type="text" class="form-input" id="documentName" placeholder="×œ×“×•×’××”: ×—×•×–×” ×¢×‘×•×“×”">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">×©× ×”× ××¢×Ÿ</label>
                        <input type="text" class="form-input" id="recipientName" placeholder="×©× ××œ×">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">××™×™×œ ×”× ××¢×Ÿ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="email" class="form-input" id="recipientEmail" placeholder="email@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">×”×•×“×¢×” ××™×©×™×ª</label>
                        <textarea class="form-textarea" id="personalMessage" placeholder="×”×•×¡×£ ×”×•×“×¢×” ××™×©×™×ª..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">×ª×•×§×£</label>
                        <select class="form-select" id="expirationDays">
                            <option value="7">7 ×™××™×</option>
                            <option value="14" selected>14 ×™××™×</option>
                            <option value="30">30 ×™××™×</option>
                            <option value="90">90 ×™××™×</option>
                            <option value="-1">×œ×œ× ×ª×•×§×£</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">××™××•×ª ×–×”×•×ª</label>
                        <select class="form-select" id="verification">
                            <option value="none">×œ×œ× ××™××•×ª</option>
                            <option value="sms">SMS</option>
                            <option value="email">××™×™×œ</option>
                            <option value="password">×¡×™×¡××”</option>
                        </select>
                    </div>
                    
                    <button class="btn-create-link" id="createLinkBtn" disabled>
                        ğŸ”— ×¦×•×¨ ×§×™×©×•×¨ ×œ×—×ª×™××”
                    </button>
                    
                    <!-- Link Result -->
                    <div class="link-result" id="linkResult">
                        <h3 style="margin-bottom: 10px;">âœ… ×”×§×™×©×•×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!</h3>
                        <div class="link-url" id="linkUrl"></div>
                        <div class="send-options">
                            <button class="btn-send btn-copy" id="copyLinkBtn">ğŸ“‹ ×”×¢×ª×§</button>
                            <button class="btn-send btn-email" id="sendEmailBtn">ğŸ“§ ××™×™×œ</button>
                            <button class="btn-send btn-whatsapp" id="sendWhatsAppBtn">ğŸ’¬ WhatsApp</button>
                            <button class="btn-send btn-qr" id="qrCodeBtn">ğŸ“± QR</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="security.js"></script>
    <script src="config.js"></script>
    <script>
        // Global State
        const AppState = {
            pdfFile: null,
            pdfDoc: null,
            currentPage: 1,
            totalPages: 0,
            scale: 1.5,
            fields: [],
            selectedFieldType: null,
            customFieldName: '',
            awaitingFieldPlacement: false,
            documents: [],
            currentDocumentId: null
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            loadHistory();
        });
        
        function initializeApp() {
            // Apply color scheme
            ZrimaPlusConfig.applyColorScheme();
            
            // Setup event listeners
            setupUploadZone();
            setupFieldSelector();
            setupPDFControls();
            setupActionButtons();
            setupCreateLink();
            setupHistory();
            
            // Security check
            const security = window.SecurityManager;
            security.log('app', 'Application initialized');
            
            console.log('âœ… Application Ready');
        }
        
        // Upload Zone
        function setupUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            uploadZone.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            // Drag and drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
        }
        
        async function handleFileUpload(file) {
            const security = window.SecurityManager;
            
            // Validate file type
            if (!security.validateFileType(file)) {
                showAlert('error', '×¨×§ ×§×‘×¦×™ PDF ××•×ª×¨×™×!');
                return;
            }
            
            // Validate file size
            if (!security.validateFileSize(file)) {
                showAlert('error', '×”×§×•×‘×¥ ×’×“×•×œ ××“×™! ××§×¡×™××•× 50MB');
                return;
            }
            
            AppState.pdfFile = file;
            
            showAlert('success', '×”×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!');
            security.log('document', 'PDF uploaded', { fileName: file.name, fileSize: file.size });
            
            await loadPDF(file);
        }
        
        async function loadPDF(file) {
            const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
            
            try {
                AppState.pdfDoc = await loadingTask.promise;
                AppState.totalPages = AppState.pdfDoc.numPages;
                AppState.currentPage = 1;
                
                document.getElementById('pdfName').textContent = file.name;
                document.getElementById('uploadZone').classList.add('hidden');
                document.getElementById('pdfViewer').style.display = 'block';
                document.getElementById('actionButtons').classList.remove('hidden');
                
                await renderPage(1);
                
                // Enable create link button if fields exist
                updateCreateLinkButton();
                
            } catch (error) {
                console.error('Error loading PDF:', error);
                showAlert('error', '×©×’×™××” ×‘×˜×¢×™× ×ª PDF');
            }
        }
        
        async function renderPage(pageNum) {
            const page = await AppState.pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: AppState.scale });
            
            const canvas = document.getElementById('pdfCanvas');
            const context = canvas.getContext('2d');
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            
            await page.render(renderContext).promise;
            
            document.getElementById('pdfPages').textContent = `×¢××•×“ ${pageNum} ××ª×•×š ${AppState.totalPages}`;
            
            // Re-render field markers
            renderFieldMarkers();
        }
        
        // Field Selector
        function setupFieldSelector() {
            const fieldButtons = document.querySelectorAll('.field-type-btn');
            const customInput = document.getElementById('customFieldName');
            const addFieldBtn = document.getElementById('addFieldBtn');
            
            fieldButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active from all
                    fieldButtons.forEach(b => b.classList.remove('active'));
                    
                    // Add active to clicked
                    btn.classList.add('active');
                    
                    const fieldType = btn.dataset.type;
                    AppState.selectedFieldType = fieldType;
                    
                    // Show custom field input if custom selected
                    if (fieldType === 'custom') {
                        customInput.classList.remove('hidden');
                        customInput.focus();
                    } else {
                        customInput.classList.add('hidden');
                        AppState.customFieldName = '';
                    }
                    
                    // Enable add field button
                    if (AppState.pdfFile) {
                        addFieldBtn.disabled = false;
                        addFieldBtn.textContent = 'â• ×”×•×¡×£ ×©×“×” - ×œ×—×¥ ×¢×œ ×”-PDF';
                        AppState.awaitingFieldPlacement = false;
                    }
                });
            });
            
            customInput.addEventListener('input', (e) => {
                AppState.customFieldName = e.target.value;
            });
            
            addFieldBtn.addEventListener('click', () => {
                if (!AppState.selectedFieldType) {
                    showAlert('warning', '×‘×—×¨ ×¡×•×’ ×©×“×” ×ª×—×™×œ×”');
                    return;
                }
                
                if (AppState.selectedFieldType === 'custom' && !AppState.customFieldName) {
                    showAlert('warning', '×”×–×Ÿ ×©× ×œ×©×“×” ×”××•×ª××');
                    return;
                }
                
                AppState.awaitingFieldPlacement = true;
                addFieldBtn.textContent = 'ğŸ‘† ×œ×—×¥ ×¢×œ ×”-PDF ×œ×”×•×¡×¤×ª ×”×©×“×”';
                addFieldBtn.style.background = '#FF9800';
            });
            
            // PDF Canvas click
            const canvas = document.getElementById('pdfCanvas');
            canvas.addEventListener('click', (e) => {
                if (!AppState.awaitingFieldPlacement) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                addFieldToDocument(x, y);
            });
        }
        
        function addFieldToDocument(x, y) {
            const fieldType = AppState.selectedFieldType;
            const fieldConfig = ZrimaPlusConfig.fieldTypes[fieldType];
            
            const field = {
                id: Date.now() + Math.random(),
                type: fieldType,
                name: fieldType === 'custom' ? AppState.customFieldName : fieldConfig.name,
                x: x,
                y: y,
                page: AppState.currentPage,
                color: fieldConfig.color,
                icon: fieldConfig.icon
            };
            
            AppState.fields.push(field);
            
            // Reset state
            AppState.awaitingFieldPlacement = false;
            const addFieldBtn = document.getElementById('addFieldBtn');
            addFieldBtn.textContent = 'â• ×”×•×¡×£ ×©×“×” - ×œ×—×¥ ×¢×œ ×”-PDF';
            addFieldBtn.style.background = 'var(--color-primary)';
            
            // Clear custom field name
            if (fieldType === 'custom') {
                AppState.customFieldName = '';
                document.getElementById('customFieldName').value = '';
            }
            
            renderFieldMarkers();
            renderFieldsList();
            updateCreateLinkButton();
            
            showAlert('success', `×©×“×” "${field.name}" × ×•×¡×£ ×‘×”×¦×œ×—×”!`);
            window.SecurityManager.log('document', 'Field added', { fieldType, fieldName: field.name });
        }
        
        function renderFieldMarkers() {
            // Remove existing markers
            document.querySelectorAll('.field-marker').forEach(marker => marker.remove());
            
            const container = document.getElementById('pdfCanvasContainer');
            
            AppState.fields.forEach(field => {
                if (field.page !== AppState.currentPage) return;
                
                const marker = document.createElement('div');
                marker.className = 'field-marker';
                marker.style.left = field.x + 'px';
                marker.style.top = field.y + 'px';
                marker.style.borderColor = field.color;
                marker.style.color = field.color;
                marker.innerHTML = `${field.icon} ${field.name}`;
                
                container.appendChild(marker);
            });
        }
        
        function renderFieldsList() {
            const fieldsList = document.getElementById('fieldsList');
            
            if (AppState.fields.length === 0) {
                fieldsList.innerHTML = '<p style="text-align: center; color: #666;">××™×Ÿ ×©×“×•×ª ×¢×“×™×™×Ÿ</p>';
                return;
            }
            
            fieldsList.innerHTML = AppState.fields.map((field, index) => `
                <div class="field-item">
                    <div class="field-item-info">
                        <span style="font-size: 20px;">${field.icon}</span>
                        <span>${field.name}</span>
                        <span style="font-size: 12px; color: #666;">(×¢××•×“ ${field.page})</span>
                    </div>
                    <button class="remove-field-btn" onclick="removeField(${index})">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        }
        
        function removeField(index) {
            AppState.fields.splice(index, 1);
            renderFieldMarkers();
            renderFieldsList();
            updateCreateLinkButton();
            showAlert('success', '×”×©×“×” ×”×•×¡×¨');
        }
        
        // PDF Controls
        function setupPDFControls() {
            document.getElementById('zoomIn').addEventListener('click', () => {
                AppState.scale += 0.25;
                renderPage(AppState.currentPage);
            });
            
            document.getElementById('zoomOut').addEventListener('click', () => {
                if (AppState.scale > 0.5) {
                    AppState.scale -= 0.25;
                    renderPage(AppState.currentPage);
                }
            });
            
            document.getElementById('prevPage').addEventListener('click', () => {
                if (AppState.currentPage > 1) {
                    AppState.currentPage--;
                    renderPage(AppState.currentPage);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                if (AppState.currentPage < AppState.totalPages) {
                    AppState.currentPage++;
                    renderPage(AppState.currentPage);
                }
            });
        }
        
        // Action Buttons
        function setupActionButtons() {
            document.getElementById('removeFile').addEventListener('click', () => {
                if (confirm('×”×× ×œ×”×¡×™×¨ ××ª ×”×§×•×‘×¥? (×”×©×“×•×ª ×™×™×©××¨×•)')) {
                    removeFile();
                }
            });
            
            document.getElementById('removeAll').addEventListener('click', () => {
                if (confirm('×”×× ×œ×”×¡×™×¨ ××ª ×”×§×•×‘×¥ ×•×›×œ ×”×©×“×•×ª?')) {
                    removeAll();
                }
            });
        }
        
        function removeFile() {
            AppState.pdfFile = null;
            AppState.pdfDoc = null;
            document.getElementById('uploadZone').classList.remove('hidden');
            document.getElementById('pdfViewer').style.display = 'none';
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            showAlert('success', '×”×§×•×‘×¥ ×”×•×¡×¨');
        }
        
        function removeAll() {
            removeFile();
            AppState.fields = [];
            renderFieldsList();
            updateCreateLinkButton();
            showAlert('success', '×”×›×œ ×”×•×¡×¨');
        }
        
        // Create Link
        function setupCreateLink() {
            const createLinkBtn = document.getElementById('createLinkBtn');
            
            createLinkBtn.addEventListener('click', createSignatureLink);
            
            document.getElementById('copyLinkBtn').addEventListener('click', copyLink);
            document.getElementById('sendEmailBtn').addEventListener('click', sendByEmail);
            document.getElementById('sendWhatsAppBtn').addEventListener('click', sendByWhatsApp);
            document.getElementById('qrCodeBtn').addEventListener('click', generateQR);
        }
        
        function updateCreateLinkButton() {
            const btn = document.getElementById('createLinkBtn');
            btn.disabled = !(AppState.pdfFile && AppState.fields.length > 0);
        }
        
        function createSignatureLink() {
            const documentName = document.getElementById('documentName').value;
            const recipientName = document.getElementById('recipientName').value;
            const recipientEmail = document.getElementById('recipientEmail').value;
            const personalMessage = document.getElementById('personalMessage').value;
            const expirationDays = parseInt(document.getElementById('expirationDays').value);
            const verification = document.getElementById('verification').value;
            
            if (!documentName || !recipientName) {
                showAlert('warning', '× × ×œ××œ× ×©× ××¡××š ×•×©× × ××¢×Ÿ');
                return;
            }
            
            const security = window.SecurityManager;
            const documentId = security.generateDocumentId();
            const signatureToken = security.generateSignatureToken();
            
            const document = {
                id: documentId,
                token: signatureToken,
                documentName,
                recipientName,
                recipientEmail,
                personalMessage,
                expirationDays,
                verification,
                fields: [...AppState.fields],
                pdfFile: AppState.pdfFile.name,
                status: 'created',
                createdAt: new Date().toISOString(),
                expiresAt: expirationDays === -1 ? null : new Date(Date.now() + expirationDays * 24 * 60 * 60 * 1000).toISOString()
            };
            
            AppState.documents.push(document);
            AppState.currentDocumentId = documentId;
            saveDocuments();
            
            const signatureLink = `${window.location.origin}/signature-page.html?token=${signatureToken}`;
            
            document.getElementById('linkUrl').textContent = signatureLink;
            document.getElementById('linkResult').style.display = 'block';
            
            showAlert('success', '×”×§×™×©×•×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
            security.log('document', 'Signature link created', { documentId, recipientName });
            
            updateHistory();
        }
        
        function copyLink() {
            const linkUrl = document.getElementById('linkUrl').textContent;
            navigator.clipboard.writeText(linkUrl).then(() => {
                showAlert('success', '×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—!');
            });
        }
        
        function sendByEmail() {
            showAlert('warning', '×©×œ×™×—×ª ××™×™×œ ×ª×‘×•×¦×¢ ×‘×’×¨×¡×” ×”×‘××”');
        }
        
        function sendByWhatsApp() {
            const linkUrl = document.getElementById('linkUrl').textContent;
            const recipientName = document.getElementById('recipientName').value;
            const documentName = document.getElementById('documentName').value;
            
            const message = `×©×œ×•× ${recipientName},%0A%0A×§×™×‘×œ×ª ××¡××š ×œ×—×ª×™××”: "${documentName}"%0A%0A×œ×—×ª×™××”:%0A${linkUrl}%0A%0A_×–×¨×™××” ×¤×œ×•×¡ - ×ª×Ÿ ×œ×›×¡×£ ×©×œ×š ×œ×–×¨×•×_`;
            
            window.open(`https://wa.me/?text=${message}`, '_blank');
        }
        
        function generateQR() {
            showAlert('warning', '×™×¦×™×¨×ª QR ×ª×‘×•×¦×¢ ×‘×’×¨×¡×” ×”×‘××”');
        }
        
        // History
        function setupHistory() {
            const searchInput = document.getElementById('searchHistory');
            const filterSelect = document.getElementById('filterStatus');
            
            searchInput.addEventListener('input', updateHistory);
            filterSelect.addEventListener('change', updateHistory);
        }
        
        function loadHistory() {
            const saved = localStorage.getItem('zrima_documents');
            if (saved) {
                AppState.documents = JSON.parse(saved);
            }
            updateHistory();
        }
        
        function saveDocuments() {
            localStorage.setItem('zrima_documents', JSON.stringify(AppState.documents));
        }
        
        function updateHistory() {
            const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filtered = AppState.documents.filter(doc => {
                const matchesSearch = doc.documentName.toLowerCase().includes(searchTerm) ||
                                    doc.recipientName.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || doc.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            const historyList = document.getElementById('historyList');
            
            if (filtered.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">×œ× × ××¦××• ××¡××›×™×</p>';
                return;
            }
            
            historyList.innerHTML = filtered.map(doc => {
                const status = ZrimaPlusConfig.documentStatuses[doc.status];
                return `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-title">${doc.documentName}</span>
                            <span class="status-badge status-${doc.status}">${status.icon} ${status.name}</span>
                        </div>
                        <div class="history-details">
                            ğŸ“„ ${doc.recipientName} | ğŸ“… ${ZrimaPlusConfig.formatDateTime(doc.createdAt)}
                        </div>
                        <div class="history-actions">
                            <button class="history-btn" style="background: var(--color-primary); color: white;" onclick="viewDocument('${doc.id}')">ğŸ‘ï¸ ×¦×¤×”</button>
                            <button class="history-btn" style="background: var(--color-danger); color: white;" onclick="deleteDocument('${doc.id}')">ğŸ—‘ï¸ ××—×§</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function viewDocument(id) {
            const doc = AppState.documents.find(d => d.id === id);
            if (doc) {
                alert(`××¡××š: ${doc.documentName}\n× ××¢×Ÿ: ${doc.recipientName}\n×¡×˜×˜×•×¡: ${ZrimaPlusConfig.documentStatuses[doc.status].name}`);
            }
        }
        
        function deleteDocument(id) {
            if (confirm('×”×× ×œ××—×•×§ ××ª ×”××¡××š?')) {
                AppState.documents = AppState.documents.filter(d => d.id !== id);
                saveDocuments();
                updateHistory();
                showAlert('success', '×”××¡××š × ××—×§');
            }
        }
        
        // Alerts
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // Make functions global
        window.removeField = removeField;
        window.viewDocument = viewDocument;
        window.deleteDocument = deleteDocument;
    </script>
</body>
</html>
